<div class="ml-36 pt-24 bg-darkBackground min-h-screen p-6">
  <!-- 喫煙カレンダー -->
  <div class="bg-cardBackground rounded-lg p-6 shadow-lg mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold flex items-center text-white">
        <%= inline_svg_tag 'icons-calendar.svg', class: "w-6 h-6 mr-2" %>
        喫煙カレンダー
      </h2>
      <div class="flex space-x-2">
        <%= link_to '前月', smoker_smoking_records_path(start_date: @start_date.prev_month), class: 'btn btn-outline btn-success btn-sm' %>
        <span class="text-white text-xl"><%= @start_date.strftime('%Y年%m月') %></span>
        <%= link_to '次月', smoker_smoking_records_path(start_date: @start_date.next_month), class: 'btn btn-outline btn-success btn-sm' %>
      </div>
    </div>
    <div class="grid grid-cols-7 gap-2">
      <% ['日', '月', '火', '水', '木', '金', '土'].each do |day| %>
        <div class="text-center font-bold text-gray-500 text-sm"><%= day %></div>
      <% end %>
      
      <% (@start_date.beginning_of_month..@end_date).each do |date| %>
        <% if date == @start_date.beginning_of_month %>
          <% date.wday.times do %>
            <div></div>
          <% end %>
        <% end %>
        
        <% is_today = date == Date.current %>
        <div class="p-2 bg-itemBackground rounded-lg text-white hover:bg-opacity-80 transition-colors h-16 flex flex-col justify-between overflow-hidden <%= 'ring-2 ring-blue-500' if is_today %>">
          <div class="text-sm font-bold <%= 'text-blue-400' if is_today %>"><%= date.day %></div>
          <% if @calendar_data[date] %>
            <div class="text-xs text-customGreen"><%= @calendar_data[date][:count] %>本</div>
            <div class="text-xs text-yellow-500"><%= number_to_currency(@calendar_data[date][:amount], unit: '¥', precision: 0) %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 喫煙記録フォーム -->
  <div class="bg-cardBackground rounded-lg p-6 mb-6 shadow-lg">
    <% if current_user.currently_quitting? %>
      <div class="bg-itemBackground p-4 mb-4" role="alert">
        <p class="font-bold">現在禁煙中です</p>
        <p>喫煙記録を追加するには、まず禁煙を終了してください。</p>
        <%= button_to "禁煙を終了する", non_smoker_quit_smoking_record_path(current_user.quit_smoking_records.active.first), 
                    method: :patch, 
                    class: "btn btn-primary mt-2",
                    data: { turbo_confirm: '本当に禁煙を終了しますか？' } %>
      </div>
    <% elsif @cigarettes.empty? %>
      <p class="text-white mb-4">タバコが登録されていません。先にタバコを登録してください。</p>
      <%= link_to "タバコを登録する", smoker_cigarettes_path, class: "btn btn-primary" %>
    <% else %>
      <%= form_with model: [:smoker, @new_smoking_record], url: smoker_smoking_records_path, local: true do |f| %>
        <fieldset class="mb-4">
          <legend class="sr-only">タバコの種類を選択</legend>
          <div class="flex flex-col sm:flex-row gap-4" role="group">
            <% @cigarettes.each_with_index do |cigarette, index| %>
              <div class="flex-1 relative">
                <%= f.radio_button :cigarette_id, cigarette.id, 
                                    class: "peer absolute inset-0 opacity-0 w-full h-full cursor-pointer", 
                                    id: "cigarette_#{cigarette.id}",
                                    checked: index == 0 %>
                <%= f.label "cigarette_#{cigarette.id}", class: "flex flex-col items-center justify-center p-4 text-gray-200 bg-gray-700 rounded-lg peer-checked:ring-2 peer-checked:ring-blue-500 peer-checked:bg-blue-600 peer-checked:text-white hover:bg-gray-600 transition-all duration-300" do %>
                  <span class="text-lg font-semibold"><%= cigarette.brand %></span>
                  <span class="text-sm opacity-70"><%= number_to_currency(cigarette.price_per_cigarette) %>/本</span>
                <% end %>
              </div>
            <% end %>
          </div>
        </fieldset>

        <%= f.button type: 'submit', class: "w-full btn btn-success text-white" do %>
          <%= inline_svg_tag 'icons-smoking.svg', class: 'w-6 h-6 mr-2' %>
          喫煙を記録
        <% end %>
      <% end %>
    <% end %>
  </div>

  <!-- 統計情報 (変更なし) -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <% [
      { icon: 'icons-coin.svg', title: "総合計金額", value: number_to_currency(@total_amount) },
      { icon: 'icons-coin.svg', title: "今日の合計金額", value: number_to_currency(@today_amount) },
      { icon: 'icons-cigarettes-pack.svg', title: "総本数", value: "#{@total_count}" },
      { icon: 'icons-cigarettes-pack.svg', title: "今日の本数", value: "#{@today_count}" }
    ].each do |item| %>
      <div class="bg-cardBackground p-4 rounded-lg shadow-lg transition duration-300 hover:shadow-xl flex items-center h-24">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center">
            <%= inline_svg_tag item[:icon], class: "w-6 h-6 mr-2"%>
            <span class="text-labelColor"><%= item[:title] %></span>
          </div>
          <div class="text-2xl font-bold text-white flex items-center">
            <%= item[:value] %>
            <% if item[:title].include?("本数") %>
              <span class="text-labelColor text-sm ml-1">本</span>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 喫煙記録ログ -->
  <div class="bg-cardBackground rounded-lg p-6 shadow-lg">
    <h2 class="text-2xl font-bold mb-4 flex items-center text-base-content">
      <i class="fas fa-clipboard-list mr-2"></i>
      今日の喫煙記録ログ
    </h2>
    <div class="max-h-[calc(100vh-400px)] overflow-y-auto">
      <ul class="space-y-3">
        <% @smoking_records.each do |log| %>
          <li class="bg-itemBackground p-3 rounded-lg shadow transition duration-300 hover:bg-base-100">
            <div class="grid grid-cols-12 items-center gap-2">
              <span class="text-base-content opacity-70 col-span-5 truncate"><%= log.smoked_at.strftime("%Y/%m/%d %H:%M") %></span>
              <span class="font-medium text-base-content col-span-3 truncate"><%= log.brand_name %></span>
              <span class="text-accent col-span-3 pl-4"><%= number_to_currency(log.price_per_cigarette) %></span>
              <div class="col-span-1 flex justify-end">
                <%= button_to smoker_smoking_record_path(log), method: :delete, data: { turbo_confirm: "本当にこの記録を削除しますか？" }, class: "btn btn-ghost btn-xs" do %>
                  <i class="fas fa-trash-alt text-error"></i>
                <% end %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
    <div class="mt-4">
      <%= paginate @smoking_records, window: 2 %>
    </div>
  </div>
</div>